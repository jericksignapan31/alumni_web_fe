<div class="alumni-container">
  <!-- Post Creation Form -->
  <div class="create-post-section">
    <input type="text" class="post-input-title" placeholder="Post title " [(ngModel)]="postTitle" [disabled]="isSubmitting" />
    <textarea class="post-input" rows="3" placeholder="What's on your mind?" [(ngModel)]="postContent" [disabled]="isSubmitting"></textarea>

    @if (selectedImagePreview) {
      <div class="image-preview">
        <img [src]="selectedImagePreview" alt="preview" />
        <button type="button" class="btn-remove" (click)="removeImage()" [disabled]="isSubmitting">âœ•</button>
      </div>
    }

    <div class="form-actions">
      <input type="file" #fileInput hidden accept="image/*" (change)="onImageSelected($event)" [disabled]="isSubmitting" />
      <button type="button" class="btn-upload" (click)="fileInput.click()" [disabled]="isSubmitting">
        <i antIcon type="picture" theme="outline"></i>
      </button>
      <button type="button" class="btn-post" (click)="submitPost()" [disabled]="isSubmitting || !postContent.trim()">
        @if (isSubmitting) {
          <span class="spinner-border spinner-border-sm" role="status"></span>
        } @else {
          <span>Post</span>
        }
      </button>
    </div>
  </div>

  <!-- Posts Feed -->
  <div class="posts-section">
    @if (isLoading) {
      <div class="text-center py-4">
        <div class="spinner-border" role="status"></div>
      </div>
    } @else if (errorMessage) {
      <div class="error-banner">
        <span>{{ errorMessage }}</span>
        <button class="btn-retry" (click)="loadPosts()">Retry</button>
      </div>
    } @else {
      @if (!posts.length) {
        <p class="no-posts">No posts yet</p>
      } @else {
        @for (post of posts; track post.id ?? post.created_at ?? post) {
          <div class="post-item">
            <div class="post-top">
              <div class="author-info">
                <div class="avatar">{{ getAuthorInitial(post) }}</div>
                <div>
                  <div class="name">{{ getAuthorName(post) }}</div>
                  <div class="date">{{ getPostDate(post) | date: 'short' }}</div>
                </div>
              </div>
            </div>

            <div class="post-content">
              @if (post.title) {
                <h6>{{ post.title }}</h6>
              }
              <p>{{ post.content || post.body || '' }}</p>
            </div>

            @if (post.upload_optional) {
              <div class="post-img">
                <img [src]="post.upload_optional" alt="post" />
              </div>
            }

            <div class="post-footer">
              <button
                type="button"
                class="action-btn"
                [class.reacted]="hasUserReacted(post)"
                (click)="reactToPost(post)"
                [disabled]="isReacting(post)"
              >
                <i antIcon type="heart" theme="outline"></i>
                @if (isReacting(post)) {
                  <span class="spinner-border spinner-border-sm" role="status"></span>
                } @else {
                  <span>{{ post.heart_count ?? post.reactions?.heart ?? 0 }}</span>
                }
              </button>
              <button type="button" class="action-btn" (click)="toggleCommentsVisibility(post)" [disabled]="isCommentsLoading(post)">
                <i antIcon type="message" theme="outline"></i>
                @if (isCommentsLoading(post)) {
                  <span class="spinner-border spinner-border-sm" role="status"></span>
                } @else {
                  <span>{{ post.comment_count ?? post.comments_count ?? post.loadedComments?.length ?? post.comments?.length ?? 0 }}</span>
                }
              </button>
            </div>

            <!-- Comments Section -->
            @if (areCommentsVisible(post) && post.loadedComments) {
              <div class="comments-section">
                @if (post.loadedComments.length === 0) {
                  <p class="no-comments">No comments yet</p>
                } @else {
                  @for (comment of post.loadedComments; track comment.comment_id ?? comment.id ?? comment) {
                    <div class="comment-item">
                      <div class="comment-author">
                        <div class="comment-avatar">{{ getCommentAuthorInitial(comment) }}</div>
                        <div class="comment-meta">
                          <div class="comment-author-name">{{ getCommentAuthorName(comment) }}</div>
                          <div class="comment-date">{{ comment.created_at | date: 'short' }}</div>
                        </div>
                      </div>
                      <div class="comment-content">{{ comment.content }}</div>
                    </div>
                  }
                }
              </div>
            }

            <div class="comment-box">
              <input
                type="text"
                class="comment-input"
                placeholder="Write a comment..."
                [(ngModel)]="commentInputs[getPostKey(post)]"
                [disabled]="isCommentSubmitting(post)"
              />
              <button
                type="button"
                class="btn-comment"
                (click)="submitComment(post)"
                [disabled]="isCommentSubmitting(post) || !commentInputs[getPostKey(post)]?.trim()"
              >
                @if (isCommentSubmitting(post)) {
                  <span class="spinner-border spinner-border-sm" role="status"></span>
                } @else {
                  <span>Comment</span>
                }
              </button>
            </div>
          </div>
        }
      }
    }
  </div>
</div>
